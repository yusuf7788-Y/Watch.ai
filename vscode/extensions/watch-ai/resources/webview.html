<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-dark: #0a0a0c;
            --bg-sidebar: #0d0d0f;
            --accent: #f59e0b;
            --accent-dim: rgba(245, 158, 11, 0.15);
            --text-main: #94a3b8;
            --text-vibrant: #e2e8f0;
            --glass: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.08);
            --red-vibrant: #ef4444;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: var(--bg-dark);
            color: var(--text-vibrant);
            font-family: 'Inter', system-ui, sans-serif;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 220px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: width 0.3s;
        }

        .sidebar.collapsed {
            width: 0;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-header img {
            height: 24px;
        }

        .sidebar-header span {
            font-weight: 700;
            font-size: 14px;
        }

        .new-chat-btn {
            margin: 12px;
            padding: 10px 14px;
            background: linear-gradient(135deg, var(--accent), #d97706);
            color: #000;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .new-chat-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        .history-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .history-item {
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 12px;
            color: var(--text-main);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
            margin-bottom: 2px;
        }

        .history-item:hover {
            background: var(--glass);
            color: var(--text-vibrant);
        }

        .history-item.active {
            background: var(--accent-dim);
            color: var(--accent);
        }

        .history-item i {
            font-size: 10px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 16px;
            border-bottom: 1px solid var(--border);
            background: rgba(13, 13, 15, 0.8);
            backdrop-filter: blur(8px);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toggle-sidebar {
            background: none;
            border: none;
            color: var(--text-main);
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
        }

        .toggle-sidebar:hover {
            background: var(--glass);
            color: var(--text-vibrant);
        }

        #task-indicator {
            font-size: 9px;
            color: var(--accent);
            font-weight: 800;
            letter-spacing: 0.8px;
        }

        .chat-viewport {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            position: relative;
        }

        /* Welcome Screen */
        #welcome-screen {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 40px;
            background: var(--bg-dark);
            z-index: 10;
            transition: opacity 0.4s, visibility 0.4s;
        }

        #welcome-screen.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .welcome-logo {
            width: 72px;
            height: 72px;
            margin-bottom: 20px;
            filter: drop-shadow(0 0 20px rgba(245, 158, 11, 0.25));
            animation: pulse 3s infinite ease-in-out;
        }

        .welcome-header {
            font-size: 22px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 6px;
            background: linear-gradient(135deg, #fff, var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .welcome-sub {
            font-size: 13px;
            color: var(--text-main);
            margin-bottom: 28px;
            max-width: 280px;
            line-height: 1.5;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            width: 100%;
            max-width: 300px;
        }

        .feature-item {
            background: var(--glass);
            border: 1px solid var(--border);
            padding: 12px;
            border-radius: 10px;
            text-align: left;
            transition: all 0.2s;
            cursor: pointer;
        }

        .feature-item:hover {
            transform: translateY(-2px);
            border-color: var(--accent);
            background: var(--accent-dim);
        }

        .feature-item i {
            color: var(--accent);
            margin-bottom: 6px;
            font-size: 14px;
            display: block;
        }

        .feature-item div {
            font-size: 11px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 2px;
        }

        .feature-item p {
            font-size: 10px;
            color: var(--text-main);
            margin: 0;
        }

        /* Messages */
        .message {
            padding: 12px 14px;
            border-radius: 10px;
            font-size: 13px;
            max-width: 90%;
            line-height: 1.55;
        }

        .user-message {
            align-self: flex-end;
            background: var(--accent-dim);
            border: 1px solid rgba(245, 158, 11, 0.2);
            color: #fff;
        }

        .bot-message {
            align-self: flex-start;
            color: var(--text-vibrant);
        }

        .bot-message code {
            background: rgba(255, 255, 255, 0.08);
            padding: 2px 5px;
            border-radius: 4px;
            font-family: 'Fira Code', monospace;
            font-size: 12px;
        }

        .bot-message pre {
            background: #000;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            overflow-x: auto;
            margin: 10px 0;
        }

        /* Footer */
        .footer {
            padding: 14px;
            border-top: 1px solid var(--border);
            background: var(--bg-dark);
        }

        .input-wrapper {
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px;
            transition: all 0.3s;
        }

        .input-wrapper:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.15);
        }

        textarea {
            width: 100%;
            height: 56px;
            background: transparent;
            border: none;
            color: white;
            resize: none;
            font-size: 13px;
            outline: none;
            line-height: 1.5;
        }

        .controls-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }

        .security-toggle {
            font-size: 10px;
            color: var(--text-main);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid transparent;
            transition: all 0.2s;
            font-weight: 600;
        }

        .security-toggle:hover {
            background: var(--glass);
            border-color: var(--border);
        }

        .security-toggle.full {
            color: var(--red-vibrant);
            border-color: rgba(239, 68, 68, 0.2);
            background: rgba(239, 68, 68, 0.05);
        }

        .security-toggle .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #22c55e;
        }

        .security-toggle.full .dot {
            background: var(--red-vibrant);
            box-shadow: 0 0 8px var(--red-vibrant);
        }

        #send-btn {
            background: linear-gradient(135deg, var(--accent), #d97706);
            color: #000;
            border: none;
            width: 34px;
            height: 34px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
        }

        #send-btn:hover {
            transform: scale(1.05);
        }

        #send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Approval cards */
        .approval-card {
            background: rgba(245, 158, 11, 0.05);
            border: 1px solid var(--border);
            padding: 12px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 3px solid var(--accent);
        }

        .approval-card.full-access {
            border-left-color: var(--red-vibrant);
        }

        .mini-terminal {
            display: none;
            background: #000;
            height: 140px;
            padding: 10px;
            font-family: 'Fira Code', monospace;
            font-size: 10px;
            overflow-y: auto;
            margin-top: 10px;
            border-radius: 6px;
            border: 1px solid var(--border);
            color: #ccc;
        }

        .action-btn {
            background: var(--glass);
            border: 1px solid var(--border);
            color: white;
            padding: 7px 12px;
            border-radius: 6px;
            font-size: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .action-btn.approve {
            background: var(--accent);
            color: #000;
            border: none;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
                filter: drop-shadow(0 0 10px rgba(245, 158, 11, 0.15));
            }

            50% {
                transform: scale(1.02);
                filter: drop-shadow(0 0 25px rgba(245, 158, 11, 0.35));
            }
        }

        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 10px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>

<body>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="{{LOGO_URI}}">
            <span>Watch AI</span>
        </div>
        <button class="new-chat-btn" onclick="newChat()">
            <i class="fa-solid fa-plus"></i> Yeni Sohbet
        </button>
        <div class="history-list" id="history-list">
            <div class="history-item active">
                <i class="fa-solid fa-message"></i>
                <span>Mevcut Sohbet</span>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="header">
            <div class="header-left">
                <button class="toggle-sidebar" onclick="toggleSidebar()">
                    <i class="fa-solid fa-bars"></i>
                </button>
                <div id="task-indicator">
                    <i class="fa-solid fa-bolt-lightning"></i> HAZIR
                </div>
            </div>
        </div>

        <div class="chat-viewport" id="viewport">
            <div id="welcome-screen">
                <img src="{{LOGO_URI}}" class="welcome-logo">
                <div class="welcome-header">Watch AI</div>
                <div class="welcome-sub">Gelişmiş otonom yapay zeka mühendisi göreve hazır.</div>

                <div class="feature-grid">
                    <div class="feature-item" onclick="quickTask('Hızlı bir React component oluştur')">
                        <i class="fa-solid fa-code"></i>
                        <div>Yeni Component</div>
                        <p>Modern kod yapısı</p>
                    </div>
                    <div class="feature-item" onclick="quickTask('Projeyi analiz et')">
                        <i class="fa-solid fa-magnifying-glass-chart"></i>
                        <div>Analiz ve Audit</div>
                        <p>Kod kalitesi</p>
                    </div>
                    <div class="feature-item" onclick="quickTask('Bugları bul ve fixle')">
                        <i class="fa-solid fa-bug-slash"></i>
                        <div>Bug Fix Otopilot</div>
                        <p>Hata tespiti</p>
                    </div>
                    <div class="feature-item" onclick="quickTask('Modern landing page hazırla')">
                        <i class="fa-solid fa-wand-magic-sparkles"></i>
                        <div>Elite UI Design</div>
                        <p>SOTA arayüz</p>
                    </div>
                </div>
            </div>
            <div id="message-list"></div>
        </div>

        <div class="footer">
            <div class="input-wrapper">
                <textarea id="chat-input" placeholder="Watch AI'ya bir görev ver..."></textarea>
            </div>
            <div class="controls-row">
                <div id="security-mode" class="security-toggle" onclick="toggleSecurity()">
                    <span class="dot"></span>
                    <i id="security-icon" class="fa-solid fa-shield-halved"></i>
                    <span id="security-text">GÜVENLİ</span>
                </div>
                <button id="send-btn">
                    <i class="fa-solid fa-arrow-up"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        const vscode = acquireVsCodeApi();
        const list = document.getElementById('message-list');
        const view = document.getElementById('viewport');
        const input = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const securityDiv = document.getElementById('security-mode');
        const securityText = document.getElementById('security-text');
        const securityIcon = document.getElementById('security-icon');
        const welcome = document.getElementById('welcome-screen');
        const indicator = document.getElementById('task-indicator');
        const sidebar = document.getElementById('sidebar');

        let currentMode = 'secure';
        let isBusy = false;

        function toggleSidebar() {
            sidebar.classList.toggle('collapsed');
        }

        function newChat() {
            vscode.postMessage({ type: 'newChat' });
            list.innerHTML = '';
            welcome.classList.remove('hidden');
        }

        function setBusy(busy) {
            isBusy = busy;
            input.disabled = busy;
            sendBtn.disabled = busy;
        }

        function quickTask(text) {
            if (isBusy) return;
            input.value = text;
            sendBtn.click();
        }

        function toggleSecurity() {
            const newMode = currentMode === 'secure' ? 'full' : 'secure';
            updateSecurityUI(newMode);
            vscode.postMessage({ type: 'setSecurityMode', value: newMode });
        }

        function updateSecurityUI(mode) {
            currentMode = mode;
            if (mode === 'full') {
                securityDiv.classList.add('full');
                securityText.innerText = 'TAM ERİŞİM';
                securityIcon.className = 'fa-solid fa-bolt';
            } else {
                securityDiv.classList.remove('full');
                securityText.innerText = 'GÜVENLİ';
                securityIcon.className = 'fa-solid fa-shield-halved';
            }
        }

        function appendMessage(role, text) {
            welcome.classList.add('hidden');
            const div = document.createElement('div');
            div.className = 'message ' + (role === 'user' ? 'user-message' : 'bot-message');
            div.innerHTML = role === 'bot' ? marked.parse(text) : text;
            list.appendChild(div);
            view.scrollTop = view.scrollHeight;
            return div;
        }

        input.onkeydown = (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (!isBusy) sendBtn.click();
            }
        };

        sendBtn.onclick = () => {
            const v = input.value.trim();
            if (v && !isBusy) {
                setBusy(true);
                appendMessage('user', v);
                vscode.postMessage({ type: 'sendMessage', value: v });
                input.value = '';
                indicator.innerHTML = '<i class="fa-solid fa-fire-flame-curved"></i> ÇALIŞIYOR...';
            }
        };

        window.addEventListener('message', e => {
            const m = e.data;
            if (m.type === 'init' || m.type === 'securityModeChanged') {
                updateSecurityUI(m.securityMode || m.value);
            } else if (m.type === 'content') {
                welcome.classList.add('hidden');
                let last = list.lastElementChild;
                if (last && last.classList.contains('bot-message')) {
                    last._raw = (last._raw || '') + m.delta;
                    last.innerHTML = marked.parse(last._raw);
                } else {
                    const d = appendMessage('bot', m.delta);
                    d._raw = m.delta;
                }
            } else if (m.type === 'tool_executing') {
                indicator.innerHTML = '<i class="fa-solid fa-cog fa-spin"></i> ' + m.name.toUpperCase();
            } else if (m.type === 'approval') {
                const div = document.createElement('div');
                div.className = 'approval-card';
                div.innerHTML = `<i class="fa-solid fa-terminal" style="color:var(--accent);margin-right:8px;"></i><b>KOMUT:</b> <code style="font-size:10px;">${m.cmd}</code><div class="mini-terminal"></div>
                    <div style="display:flex;gap:8px;margin-top:10px;">
                    <button class="action-btn approve" onclick="vscode.postMessage({type:'terminalApproval',id:'${m.id}',choice:true});this.parentElement.style.display='none';this.parentElement.previousElementSibling.style.display='block';">ÇALIŞTIR</button>
                    <button class="action-btn" onclick="vscode.postMessage({type:'terminalApproval',id:'${m.id}',choice:false});this.closest('.approval-card').style.opacity='0.4';">REDDET</button></div>`;
                list.appendChild(div);
            } else if (m.type === 'terminal_out') {
                const cards = document.querySelectorAll('.approval-card');
                const last = cards[cards.length - 1]?.querySelector('.mini-terminal');
                if (last) { last.innerText += m.data; last.scrollTop = last.scrollHeight; }
            } else if (m.type === 'edit_pending') {
                const div = document.createElement('div');
                div.className = 'approval-card';
                div.innerHTML = `<i class="fa-solid fa-file-pen" style="color:var(--accent);margin-right:8px;"></i><b>DÜZENLEME:</b> <span style="font-family:monospace">${m.filename}</span><br><span style="font-size:10px;color:#4caf50">+${m.added}</span> <span style="font-size:10px;color:#ef4444">-${m.removed}</span>
                    <div style="display:flex;gap:8px;margin-top:12px;">
                    <button class="action-btn approve" onclick="vscode.postMessage({type:'approveEdit',file:'${m.file}'});this.closest('.approval-card').remove();">UYGULA</button>
                    <button class="action-btn" onclick="vscode.postMessage({type:'rejectEdit',file:'${m.file}'});this.closest('.approval-card').remove();">VAZGEÇ</button></div>`;
                list.appendChild(div);
            } else if (m.type === 'done') {
                setBusy(false);
                indicator.innerHTML = '<i class="fa-solid fa-bolt-lightning"></i> HAZIR';
            } else if (m.type === 'error') {
                setBusy(false);
                const div = document.createElement('div');
                div.className = 'message bot-message';
                div.style.color = 'var(--red-vibrant)';
                div.style.background = 'rgba(239, 68, 68, 0.05)';
                div.innerHTML = '<i class="fa-solid fa-circle-exclamation" style="margin-right:8px;"></i><b>Hata:</b> ' + m.value;
                list.appendChild(div);
                indicator.innerHTML = '<i class="fa-solid fa-triangle-exclamation" style="color:var(--red-vibrant)"></i> HATA';
            } else if (m.type === 'reset') {
                setBusy(false);
                list.innerHTML = '';
                welcome.classList.remove('hidden');
            }
            view.scrollTop = view.scrollHeight;
        });
    </script>
</body>

</html>